# 🎯 부드러운 주행 튜닝 (SMOOTH DRIVING)

## 날짜: 2025-10-20

---

## 🚨 문제점

### 이전 실험 결과 분석

```
평균 오차: 0.501m
최대 오차: 1.722m
성공률: 0.0%

문제:
1. 구불구불한 주행 (급격한 조향 변화)
2. 큰 각도 오차 (yaw_err=-119°, -146°)
3. omega 클램핑 (ω=-1.00)
4. Cross-track 오차 1.7m
```

### 로그 분석

```
[CONSIST] yaw_err=-119.5°, v=0.08, ω=-1.00  ⚠️⚠️⚠️
[CONSIST] yaw_err=-146.1°, v=0.08, ω=-1.00
[CONSIST] ct_raw=-1.709m, ct_filt=-1.709m
```

**문제점:**
1. **k_th = 0.9**: 조향 게인이 높아서 민감하게 반응
2. **ct_gain = 1.9-2.5**: Cross-track 보정이 너무 강함
3. **lookahead = 1.0-1.1m**: 너무 짧아서 급격한 조향 변화
4. **omega_max = 0.5**: 큰 보정 필요 시 제한에 걸림
5. **v_max = 0.10**: 속도가 약간 빠름

---

## 🔧 해결 방법

### 핵심 전략: "천천히, 멀리 보고, 부드럽게"

1. **조향 게인 감소** → 민감도 낮춤
2. **Lookahead 증가** → 더 멀리 보고 부드럽게
3. **Cross-track gain 감소** → 과도한 보정 방지
4. **필터 강화** → 노이즈 제거
5. **속도 감소** → 안정성 확보

---

## 📊 변경 사항

### 1. 속도 감소

| 파라미터 | 이전 | **현재** | 변화 |
|----------|------|----------|------|
| `v_max` | 0.10 m/s | **0.08 m/s** | ⬇️ 20% |
| `v_min` | 0.08 m/s | **0.06 m/s** | ⬇️ 25% |
| `lock_speed` | 0.10 m/s | **0.08 m/s** | ⬇️ 20% |
| `approach_speed_max` | 0.12 m/s | **0.08 m/s** | ⬇️ 33% |
| `approach_speed_align` | 0.10 m/s | **0.06 m/s** | ⬇️ 40% |

**효과:**
- 부드러운 가속/감속
- 더 안정적인 제어
- 오버슛 감소

---

### 2. 조향 게인 감소 ⭐

| 파라미터 | 이전 | **현재** | 변화 |
|----------|------|----------|------|
| `k_th` | 0.9 | **0.4** | ⬇️ 56% ⭐⭐⭐ |

**효과:**
```
이전: yaw_err=10° → omega = 0.9 × 0.17 = 0.15 rad/s (민감)
현재: yaw_err=10° → omega = 0.4 × 0.17 = 0.07 rad/s (부드러움) ✅
```

---

### 3. Cross-track Gain 대폭 감소 ⭐⭐⭐

| 구간 | 이전 Gain | **현재 Gain** | 변화 |
|------|-----------|---------------|------|
| **Sharp** (>0.3) | 2.5 | **1.2** | ⬇️ 52% |
| **Medium** (>0.15) | 2.2 | **1.0** | ⬇️ 55% |
| **Straight** (≤0.15) | 1.9 | **0.8** | ⬇️ 58% |

**효과:**
```
이전: ct_error=0.5m → correction = 2.5 × 0.5 = 1.25 rad/s (과도함) ❌
현재: ct_error=0.5m → correction = 1.2 × 0.5 = 0.60 rad/s (적절함) ✅
```

---

### 4. Lookahead 증가 ⭐⭐⭐

| 구간 | 이전 | **현재** | 변화 |
|------|------|----------|------|
| **Sharp** (>0.3) | 1.0m | **2.0m** | ⬆️ 100% |
| **Medium** (>0.15) | 1.0m | **2.5m** | ⬆️ 150% |
| **Straight** (≤0.15) | 1.1m | **3.0m** | ⬆️ 173% |

**효과:**
```
짧은 lookahead (1.0m):
━━━━━━━━━━━━━
    ⭐ (가까움)
🤖 ─┘
→ 급격한 조향 변화 ❌

긴 lookahead (2.5m):
━━━━━━━━━━━━━
         ⭐ (멀리)
🤖 ──────┘
→ 부드러운 조향 ✅
```

---

### 5. 필터 강화

| 파라미터 | 이전 | **현재** | 변화 |
|----------|------|----------|------|
| `alpha` | 0.70 | **0.80** | ⬆️ 14% |

**효과:**
```
낮은 alpha (0.70): 빠른 반응, 노이즈에 민감
높은 alpha (0.80): 느린 반응, 부드러운 움직임 ✅
```

---

### 6. 보정 한계 감소

| 파라미터 | 이전 | **현재** | 변화 |
|----------|------|----------|------|
| `ct_correction` | ±0.85 rad/s | **±0.4 rad/s** | ⬇️ 53% |

**효과:**
```
이전: 최대 ±0.85 rad/s (48.7°/s) 보정 가능
현재: 최대 ±0.4 rad/s (22.9°/s) 보정 가능
→ 급격한 조향 방지 ✅
```

---

## 📈 예상 효과

### Before (이전 - 구불구불)

```
┌──────────────────────────────┐
│ 문제점:                      │
│ - 급격한 조향 변화           │
│ - yaw_err: -119°, -146°      │
│ - omega 클램핑 (-1.00)       │
│ - ct_error: 1.7m             │
│ - 평균 오차: 0.501m          │
└──────────────────────────────┘

경로:  ━━━━━━━━━━━━━━━
로봇:  ╱╲╱╲╱╲╱╲╱╲╱╲   ❌ 구불구불
```

### After (현재 - 부드러움)

```
┌──────────────────────────────┐
│ 예상 개선:                   │
│ - 부드러운 조향 변화         │
│ - yaw_err: < ±30°            │
│ - omega: < ±0.5 rad/s        │
│ - ct_error: < 0.5m           │
│ - 평균 오차: < 0.3m          │
└──────────────────────────────┘

경로:  ━━━━━━━━━━━━━━━
로봇:  ───────────────  ✅ 부드러움
```

---

## 🔍 세부 메커니즘

### 1. 짧은 Lookahead의 문제

```
Lookahead 1.0m (이전):

경로: ━━━①━━━②━━━③━━━④━━━
            🤖 (현재)
            ↓ 1.0m
            ②

문제:
- 가까운 점만 봄
- 급격한 경로 변화에 민감
- 조향이 급격하게 변함
```

### 2. 긴 Lookahead의 효과

```
Lookahead 2.5m (현재):

경로: ━━━①━━━②━━━③━━━④━━━
            🤖 (현재)
            ↓ 2.5m
                  ④

효과:
- 먼 점을 봄
- 경로 변화를 미리 예측
- 조향이 부드럽게 변함 ✅
```

---

### 3. 높은 Gain의 문제

```
높은 Gain (2.5):

ct_error = 0.5m
correction = 2.5 × 0.5 = 1.25 rad/s

문제:
- 과도한 보정
- 오버슈트 발생
- 구불구불한 주행
```

### 4. 낮은 Gain의 효과

```
낮은 Gain (1.2):

ct_error = 0.5m
correction = 1.2 × 0.5 = 0.60 rad/s

효과:
- 적절한 보정
- 오버슈트 감소
- 부드러운 주행 ✅
```

---

## 📊 비교표

| 항목 | 이전 (구불구불) | 현재 (부드러움) | 개선 |
|------|----------------|----------------|------|
| **조향 민감도** | 높음 (k_th=0.9) | **낮음 (k_th=0.4)** | ✅ 56% 감소 |
| **보정 강도** | 강함 (gain=1.9-2.5) | **적절 (gain=0.8-1.2)** | ✅ 50-58% 감소 |
| **시야 거리** | 짧음 (1.0-1.1m) | **김 (2.0-3.0m)** | ✅ 100-173% 증가 |
| **최대 보정** | ±0.85 rad/s | **±0.4 rad/s** | ✅ 53% 감소 |
| **속도** | 0.10 m/s | **0.08 m/s** | ✅ 20% 감소 |
| **필터링** | 중간 (α=0.70) | **강함 (α=0.80)** | ✅ 14% 증가 |

---

## 🎯 기대 효과

### 1. 부드러운 조향

```
이전:
omega: -1.00 → 0.50 → -0.80 → 0.60  (급격함) ❌

현재 (예상):
omega: -0.20 → 0.10 → -0.15 → 0.12  (부드러움) ✅
```

### 2. 적절한 보정

```
이전:
ct_error → 과도한 보정 → 오버슈트 → 반대 방향 과보정
→ 구불구불 ❌

현재:
ct_error → 적절한 보정 → 점진적 수렴 → 안정
→ 부드러움 ✅
```

### 3. 안정적인 주행

```
이전:
짧은 lookahead + 높은 gain
→ 민감한 반응
→ 노이즈에 취약
→ 불안정 ❌

현재:
긴 lookahead + 낮은 gain + 강한 필터
→ 둔감한 반응 (좋은 의미!)
→ 노이즈 필터링
→ 안정 ✅
```

---

## ⚠️ 주의사항

### 1. 정확도 vs 부드러움 트레이드오프

```
부드러운 설정 (현재):
✅ 장점: 구불구불하지 않음, 안정적
❌ 단점: 정확도가 약간 떨어질 수 있음

해결:
- 느린 속도 (0.08 m/s)로 보완
- 충분한 시간을 들여 정확한 추종
```

### 2. 급커브에서의 반응

```
부드러운 설정:
- Lookahead가 길어서 급커브 예측
- Gain이 낮아서 천천히 회전

결과:
- 코너 커팅 가능성 있음
- 하지만 속도가 느려서 괜찮음 ✅
```

### 3. 초기 오프셋

```
부드러운 설정:
- 초기 오프셋 보정이 느림
- 하지만 점진적으로 수렴

권장:
- 로봇을 경로 시작점 근처 (±0.5m)에 배치
- 자동 캘리브레이션 활용
```

---

## 🧪 테스트 방법

### 1. 실행

```bash
cd /root/nav2_v2/rtk_nav/rtk_gps_planner
source ~/.bashrc
python3 single_experiment.py 1
```

### 2. 관찰 포인트

#### 조향 변화
```
로그 확인:
[CONSIST] yaw_err=XX°, ω=YY

기대:
- yaw_err < ±30° (부드러운 각도 변화)
- ω < ±0.5 rad/s (제한 내)
- ω 값이 천천히 변화
```

#### Cross-track 오차
```
로그 확인:
[CONSIST] ct_raw=XXm, ct_filt=YYm

기대:
- ct_raw < 0.5m (적절한 오차)
- ct_filt가 부드럽게 변화
- 급격한 점프 없음
```

#### 전체 움직임
```
시각적 확인:
- 구불구불하지 않음 ✅
- 경로를 완만하게 따라감 ✅
- 급격한 회전 없음 ✅
```

---

## 📈 예상 성능

| 지표 | 이전 | **예상** |
|------|------|----------|
| 평균 오차 | 0.501m | **< 0.3m** ✅ |
| 최대 오차 | 1.722m | **< 0.6m** ✅ |
| yaw_err 범위 | ±146° | **< ±30°** ✅ |
| omega 범위 | ±1.0 (클램핑) | **< ±0.5** ✅ |
| 부드러움 | ❌ 구불구불 | **✅ 완만함** |
| 안정성 | ❌ 불안정 | **✅ 안정적** |

---

## 🎯 정리

### 핵심 변경사항

1. **조향 게인 ⬇️**: 0.9 → 0.4 (56% 감소)
2. **보정 강도 ⬇️**: 1.9-2.5 → 0.8-1.2 (50-58% 감소)
3. **시야 거리 ⬆️**: 1.0-1.1m → 2.0-3.0m (100-173% 증가)
4. **속도 ⬇️**: 0.10 → 0.08 m/s (20% 감소)
5. **필터 ⬆️**: α=0.70 → 0.80 (14% 증가)
6. **보정 한계 ⬇️**: ±0.85 → ±0.4 rad/s (53% 감소)

### 핵심 철학

```
"천천히, 멀리 보고, 부드럽게"

✅ 천천히: 속도 감소 (0.08 m/s)
✅ 멀리 보고: Lookahead 증가 (2.0-3.0m)
✅ 부드럽게: Gain 감소, 필터 강화
```

---

**버전: v8 (SMOOTH DRIVING)**  
**날짜: 2025-10-20**  
**상태: 테스트 준비 완료 🚀**

**기대: 구불구불 → 부드럽고 안정적인 주행!** ✅
