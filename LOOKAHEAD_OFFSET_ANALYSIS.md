# 🔍 Lookahead와 오프셋 현상 심층 분석

## 📊 현재 상황

### 관찰된 현상
- 파란색 경로가 검은색 레퍼런스보다 **바깥쪽에 평행**하게 위치
- 경로 **형태는 비슷**하지만 **일정 거리 오프셋**
- 특히 직선 구간에서도 오프셋 유지

### 사용자 가설
> "lookahead가 증가해서 경로 위에 표기하지 않고 오프셋이 된 채로 표기가 되는거야?"

**답: 부분적으로 맞습니다!** 하지만 메커니즘이 복잡합니다.

---

## 🎯 Lookahead가 오프셋을 만드는 메커니즘

### Pure Pursuit의 기본 원리

```
로봇 위치: (x_robot, y_robot)
              ↓
         [lookahead 거리만큼 앞 경로상의 점 찾기]
              ↓
목표 위치: (x_target, y_target)
              ↓
         [목표를 향해 조향]
```

### Lookahead가 짧을 때 (0.8-1.0m)

```
경로: ━━━━━━━━━━━━━
           ↑ (목표: 0.9m 앞)
로봇: 🤖 ←─┘
      (바로 앞 점만 봄)

결과: 경로를 정확히 따라감
```

### Lookahead가 길 때 (1.2-1.5m)

```
경로: ━━━━━━━━━━━━━
              ↑ (목표: 1.5m 앞)
로봇: 🤖 ←────┘
      (멀리 봄)

문제: 멀리 보면서 직선으로 가려는 경향
```

---

## 🔍 오프셋이 발생하는 3단계 과정

### Phase 1: 초기 이탈 (시작 구간)

```
1. 로봇이 약간 바깥쪽에 위치 (예: +0.2m)
   
   경로: ━━━━━━━━━━━━━
   로봇:     🤖 (+0.2m 바깥)
```

### Phase 2: 보정 시도하지만...

```
2. Cross-track gain이 약하면 (1.5-2.0):
   
   경로: ━━━━━━━━━━━━━
              ↑ 목표 (1.5m 앞)
   로봇:     🤖 ←────┘
         (+0.2m)
   
   보정력: omega = gain × error
         = 1.5 × 0.2 = 0.3 rad/s (약함!)
```

### Phase 3: 평형 상태 (오프셋 유지)

```
3. 보정력이 약해서 경로로 돌아오지 못함
   
   경로: ━━━━━━━━━━━━━━━━
   실제: ━━━━━━━━━━━━━━━━ (+0.3m 오프셋 유지)
         🤖 → → → →
   
   이탈력 = 보정력 (평형!)
```

---

## 💡 핵심: 평형 상태 (Equilibrium)

### 왜 오프셋이 유지되는가?

```python
# 로봇이 경로에서 0.3m 바깥에 있을 때

보정력 = cross_track_gain × error
       = 1.5 × 0.3 
       = 0.45 rad/s (안쪽으로 당기는 힘)

이탈력 = lookahead가 길어서 생기는 shortcut 경향
       ≈ 0.45 rad/s (바깥으로 밀어내는 힘)

결과: 보정력 ≈ 이탈력
     → 평형 상태!
     → 오프셋 유지!
```

---

## 📊 이전 vs 현재 비교

### 이전 설정 (Gain 3.0, Lookahead 0.9m)

```
상황: 로봇이 +0.3m 바깥에 위치

보정력 = 3.0 × 0.3 = 0.9 rad/s (매우 강함!)
이탈력 (short lookahead) = 0.3 rad/s (약함)

결과: 보정력 >> 이탈력
     → 경로 안쪽으로 과도하게 보정
     → 왼쪽(안쪽) 이탈 ❌
```

### 현재 설정 (Gain 2.0, Lookahead 1.5m)

```
상황: 로봇이 +0.3m 바깥에 위치

보정력 = 2.0 × 0.3 = 0.6 rad/s (약함)
이탈력 (long lookahead) = 0.6 rad/s (강함)

결과: 보정력 ≈ 이탈력
     → 평형 상태
     → 오프셋 유지 ❌
```

---

## 🎯 "오프셋이 된 채로 표기" 정확한 의미

### 예, 맞습니다!

**Lookahead 증가의 직접적 영향:**

1. **Shortcut 경향 증가**
   - 멀리 보면 곡선의 출구를 향해 직선으로 가려 함
   - 이것이 바깥쪽으로 밀어냄

2. **보정력 상쇄**
   - Gain이 약하면 (1.5-2.0) 보정력도 약함
   - Lookahead의 이탈력과 균형
   - 결과: 오프셋이 고정됨

3. **형태는 유지, 위치만 이동**
   - 경로의 모양은 따라가지만
   - 일정 거리 떨어진 채로 주행
   - 마치 "경로를 복사해서 옆으로 옮긴 것" 같음

---

## 📈 수치 예시

### 시나리오: 로봇이 0.3m 바깥에 위치

| 설정 | Gain | Lookahead | 보정력 | 이탈력 | 결과 |
|------|------|-----------|--------|--------|------|
| **이전** | 3.0 | 0.9m | 0.9 rad/s | 0.3 rad/s | 안쪽 이탈 ⬅️ |
| **현재** | 2.0 | 1.5m | 0.6 rad/s | 0.6 rad/s | **오프셋 유지** ⚖️ |
| **이상적** | 2.5 | 1.0m | 0.75 rad/s | 0.4 rad/s | 경로 복귀 ✅ |

---

## 🔍 직선 구간에서도 오프셋이 유지되는 이유

### 의문점
> "직선에서는 corner cutting이 없는데 왜 오프셋이 유지되지?"

### 답변

```
직선 구간에서:

1. 이미 0.3m 바깥에 위치
   
   경로: ━━━━━━━━━━━━━
   실제:   ━━━━━━━━━━━━━ (+0.3m)

2. Gain이 약함 (1.5)
   보정력 = 1.5 × 0.3 = 0.45 rad/s
   
3. Lookahead가 김 (1.5m)
   → 멀리 있는 점을 향함
   → 현재 위치에서 그 점으로 직선
   → 약간의 바깥쪽 편향

4. 결과:
   약한 보정력 + 긴 lookahead의 관성
   = 오프셋 그대로 유지!
```

---

## 💡 핵심 인사이트

### 1. Lookahead의 이중 효과

```
Lookahead 증가 →
  1) Corner에서 shortcut (바깥쪽 이탈)
  2) 직선에서도 "관성" 유지 (오프셋 유지)
```

### 2. Gain과의 상호작용

```
Lookahead ⬆️ + Gain ⬇️ = 재앙!
  → 이탈력 ⬆️ + 보정력 ⬇️
  → 평형 상태 = 오프셋 고정
```

### 3. 왜 "평행"하게 보이는가?

```
Pure Pursuit은 "방향"을 제어
Cross-track correction은 "위치"를 보정

Gain이 약하면:
  → 방향만 따라감 (형태 유사)
  → 위치 보정 실패 (오프셋 유지)
  → 결과: 경로를 복사해서 옆에 붙인 것처럼!
```

---

## 🎯 결론

### 사용자의 직관이 정확합니다!

> "lookahead가 증가해서 경로 위에 표기하지 않고 오프셋이 된 채로 표기"

**정확한 메커니즘:**

1. **Lookahead 증가** (1.5m)
   - 멀리 보면서 shortcut 시도
   - 바깥쪽으로 이탈력 발생

2. **Gain 감소** (2.0)
   - 보정력 약화
   - 이탈을 수정하지 못함

3. **평형 상태**
   - 이탈력 ≈ 보정력
   - 오프셋이 고정됨

4. **결과**
   - 경로 형태는 따라가지만
   - 일정 거리 떨어진 채로 "평행 주행"
   - 마치 경로를 옆으로 복사한 것처럼!

### 해결책

**Lookahead를 줄여야 합니다!**
- 1.5m → **1.0-1.1m** 정도로
- 이렇게 하면 이탈력이 감소
- Gain은 2.3-2.5 정도로 약간 올려서 보정력 증가
- 보정력 > 이탈력 → 경로 복귀! ✅
