# IMU 수동 캘리브레이션 가이드

## 📋 개요

10번 실험 전에 **딱 1번** IMU를 캘리브레이션하면, 모든 실험에서 동일한 yaw_bias를 사용합니다.

**장점:**
- ✅ 매우 정확함 (실제 로봇 정렬 기반)
- ✅ 재현 가능한 결과 (모든 실험에서 동일한 bias)
- ✅ 한 번만 하면 됨 (10번 실험 전)

---

## 🔧 캘리브레이션 절차

### **Step 1: 로봇 준비**

1. 로봇을 **경로 시작점 (0, 0) 근처**에 위치시킵니다
   - 정확히 (0, 0)일 필요는 없음 (±0.5m 정도 괜찮음)

2. 로봇을 **경로 방향으로 정렬**합니다
   - 경로의 첫 번째 segment 방향 (path[0] → path[1])
   - `taught_path.csv`를 확인하여 방향을 파악

3. 로봇이 **정지** 상태인지 확인

---

### **Step 2: 캘리브레이션 실행**

```bash
cd /root/nav2_v2/rtk_nav/rtk_gps_planner
source ~/.bashrc  # ROS 환경 설정
python3 calibrate_imu.py
```

**출력 예시:**
```
============================================================
🎯 IMU 캘리브레이션 시작!
============================================================

📍 준비 사항:
   1. 로봇을 경로 시작점 (0, 0) 근처에 위치시키세요
   2. 로봇을 경로 방향으로 정렬하세요
      (경로 방향: 175.9°)

⏳ IMU 데이터 수집 중... (3초)

============================================================
🎯 IMU 캘리브레이션 완료!
============================================================
   경로 방향:        175.9°
   IMU Raw (평균):   120.2°
   계산된 Bias:      55.7°
   보정 후 Yaw:      175.9°

💾 저장됨: imu_calibration.txt

✅ 이제 실험을 시작할 수 있습니다!
   python3 run_all_experiments.py
============================================================
```

---

### **Step 3: 실험 실행**

캘리브레이션이 완료되면, 모든 실험에서 저장된 bias를 사용합니다:

```bash
# 단일 실험
python3 single_experiment.py 1

# 10번 실험 (자동)
python3 run_all_experiments.py
```

**실행 시 로그:**
```
============================================================
🎯 IMU Calibration Loaded from File!
   Pre-calibrated bias: 55.7°
   Raw IMU yaw: 121.5°
   Corrected yaw: 177.2°
============================================================
```

---

## 📝 저장 파일

- **imu_calibration.txt**: yaw_bias 값 저장
  - 한 줄에 하나의 숫자 (radian)
  - 예: `0.9722` (55.7도)

---

## 🔄 재캘리브레이션이 필요한 경우

다음과 같은 경우 **재캘리브레이션**이 필요합니다:

1. IMU 센서가 물리적으로 회전/이동한 경우
2. 로봇의 좌표계가 변경된 경우
3. 실험 결과가 이상한 경우 (모든 실험에서 일관되게 틀린 방향)

**재캘리브레이션 방법:**
```bash
# 기존 캘리브레이션 파일 삭제
rm imu_calibration.txt

# 재캘리브레이션
python3 calibrate_imu.py
```

---

## ⚠️ Fallback (자동 캘리브레이션)

`imu_calibration.txt` 파일이 없으면, 자동으로 경로 방향을 사용하여 캘리브레이션합니다.

**단점:**
- 시작 위치에 따라 약간 다를 수 있음
- 수동 캘리보다 정확도가 낮음

**경고 로그:**
```
⚠️  imu_calibration.txt not found!
   Using automatic calibration (less accurate)
   Run "python3 calibrate_imu.py" for manual calibration
```

---

## ✅ 체크리스트

실험 전:
- [ ] 로봇을 경로 시작점 근처에 위치
- [ ] 로봇을 경로 방향으로 정렬
- [ ] `python3 calibrate_imu.py` 실행
- [ ] `imu_calibration.txt` 파일 생성 확인
- [ ] 실험 실행 (`python3 run_all_experiments.py`)

---

## 📞 문제 해결

### 문제: IMU 데이터를 받지 못함

**증상:**
```
❌ IMU 데이터를 받지 못했습니다!
   /imu/data 토픽을 확인하세요.
```

**해결:**
1. IMU가 켜져 있는지 확인
2. ROS topic 확인: `ros2 topic echo /imu/data`
3. IMU 드라이버가 실행 중인지 확인

### 문제: 경로 파일을 찾을 수 없음

**증상:**
```
FileNotFoundError: taught_path.csv
```

**해결:**
1. 현재 디렉토리 확인: `pwd`
2. `/root/nav2_v2/rtk_nav/rtk_gps_planner`로 이동
3. `taught_path.csv` 파일 존재 확인: `ls taught_path.csv`

---

## 📊 예상 결과

**캘리브레이션 전 (자동):**
- 실험마다 다른 yaw_bias
- 평균 오차: 0.3m ~ 0.4m
- 재현성 낮음

**캘리브레이션 후 (수동):**
- 모든 실험에서 동일한 yaw_bias
- 평균 오차: 0.2m ~ 0.25m (예상)
- 재현성 높음

---

**작성: 2025-10-22**
**버전: 1.0**

