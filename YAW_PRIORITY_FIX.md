# Yaw Priority Fix - ë°©í–¥ ë³µêµ¬ ìš°ì„ ìˆœìœ„

## ğŸ“Š ë¬¸ì œ ë¶„ì„

### ë¡œê·¸ì—ì„œ ë°œê²¬ëœ ë¬¸ì œì :
```
[12077] pos=(-9.21,-1.45)
        IMU yaw: -71.3Â°  â† ë¡œë´‡ ë°©í–¥
        Path direction: -7.7Â°  â† ê²½ë¡œ ë°©í–¥
        ì°¨ì´: 63Â° í‹€ì–´ì§! ğŸ’¥
        
        yaw_error: 52.4Â°
        ct_error: -0.62m
        
        ê²°ê³¼: Ï‰=-0.09 rad/s  â† ê±°ì˜ ì•ˆ ëŒìŒ! ğŸ˜±
```

### ê·¼ë³¸ ì›ì¸:
**ë‘ ì œì–´ ëª…ë ¹ì´ ì„œë¡œ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ìƒì‡„!**

```python
omega = k_th * yaw_error + ct_correction

# Yaw correction (ë°©í–¥ ë³µêµ¬)
yaw_correction = 0.5 * 0.91 = +0.45 rad/s  â† "ì˜¤ë¥¸ìª½ìœ¼ë¡œ ëŒì•„!"

# Cross-track correction (ìœ„ì¹˜ ë³µêµ¬)
ct_correction = 1.3 * (-0.62) = -0.80
â†’ ì œí•œ: -0.55 rad/s  â† "ì™¼ìª½ìœ¼ë¡œ ëŒì•„!"

# í•©ì‚°
omega = +0.45 + (-0.55) = -0.10 rad/s  â† ê±°ì˜ ìƒì‡„! ğŸ’¥
```

**ê²°ê³¼:**
- ë¡œë´‡ì´ 63Â° í‹€ì–´ì ¸ ìˆëŠ”ë°
- ê±°ì˜ ì•ˆ ëŒê³  ìˆìŒ (5Â°/së§Œ íšŒì „)
- ë°©í–¥ ë³µêµ¬ ì‹¤íŒ¨ â†’ ê³„ì† í‹€ì–´ì§„ ìƒíƒœ

---

## ğŸ’¡ **ì™œ ì´ëŸ° ì¼ì´ ë°œìƒí•˜ëŠ”ê°€?**

### ì»¤ë¸Œ í›„ ìƒí™©:
```
1. Uí„´ ì™„ë£Œ
2. ë¡œë´‡ì´ ì•½ê°„ í‹€ì–´ì§ (20-30Â°)
3. Cross-track error ë°œìƒ (-0.3m)
4. ë‘ ë³´ì •ì´ ì„œë¡œ ë°˜ëŒ€ ë°©í–¥
5. ë¡œë´‡ì´ ì œëŒ€ë¡œ ì•ˆ ëŒìŒ
6. Yaw error ì¦ê°€ (30Â° â†’ 50Â°)
7. Cross-track error ì¦ê°€ (-0.3m â†’ -0.6m)
8. ì•…ìˆœí™˜! ğŸ”„
```

### ë¬¸ì œì˜ ë³¸ì§ˆ:
**ë‘ ëª©í‘œê°€ ì¶©ëŒ:**
- **Yaw correction**: "ê²½ë¡œ ë°©í–¥ìœ¼ë¡œ ëŒì•„!" (ìš°ì„ ìˆœìœ„ ë†’ì•„ì•¼ í•¨)
- **CT correction**: "ê²½ë¡œ ìœ„ë¡œ ê°€!" (ìš°ì„ ìˆœìœ„ ë‚®ì•„ì•¼ í•¨)

**í•˜ì§€ë§Œ í˜„ì¬:**
- ë‘ ë³´ì •ì„ ë™ë“±í•˜ê²Œ í•©ì‚°
- CT correctionì´ yaw correctionì„ ìƒì‡„
- ë°©í–¥ ë³µêµ¬ ì‹¤íŒ¨

---

## ğŸ”§ í•´ê²°ì±…: Yaw Priority (ë°©í–¥ ìš°ì„ )

### ê°œë…:
**ë¡œë´‡ì´ í¬ê²Œ í‹€ì–´ì¡Œì„ ë•ŒëŠ” ë°©í–¥ ë³µêµ¬ê°€ ìµœìš°ì„ !**

**ë¡œì§:**
```python
if abs(yaw_error) > 30Â°:  # í¬ê²Œ í‹€ì–´ì§
    ct_correction = 0  # ìœ„ì¹˜ ë³´ì • ë¬´ì‹œ!
    # ë°©í–¥ë§Œ ë³µêµ¬
```

**ì´ìœ :**
1. ë°©í–¥ì´ í‹€ì–´ì§€ë©´ ìœ„ì¹˜ëŠ” ë” í‹€ì–´ì§
2. ë°©í–¥ ë¨¼ì € ë³µêµ¬ â†’ ìœ„ì¹˜ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ë³µêµ¬
3. ìœ„ì¹˜ ë³´ì •ì€ ë°©í–¥ ë³µêµ¬ í›„!

---

## ğŸ’» êµ¬í˜„ ë‚´ìš©

### ì½”ë“œ:
```python
ct_correction = ct_gain * self.filtered_ct_error
ct_correction = max(-0.55, min(0.55, ct_correction))

# ğŸ¯ FIX 5: í° yaw error ì‹œ ë°©í–¥ ë³µêµ¬ ìš°ì„ !
ct_correction_original = ct_correction
if abs(yaw_error) > math.radians(30):  # 30ë„ ì´ìƒ í‹€ì–´ì§
    ct_correction = 0  # ìœ„ì¹˜ ë³´ì • ë¬´ì‹œ, ë°©í–¥ë§Œ ë³µêµ¬!
    self.get_logger().info(f'[YAW PRIORITY] Large yaw error {yaw_error}Â° â†’ Disabling ct_correction')

omega = self.k_th * yaw_error + ct_correction
```

### ë¡œê·¸ ì¶œë ¥:
```
[YAW PRIORITY] Large yaw error 52.4Â° â†’ Disabling ct_correction (-0.55 â†’ 0.00)
```

---

## ğŸ“ˆ ì˜ˆìƒ íš¨ê³¼

### ê¸°ì¡´ ë¬¸ì œ:
```
yaw_error: 52Â° â†’ omega: +0.45
ct_error: -0.62m â†’ omega: -0.55
í•©ì‚°: -0.10 rad/s  â† ê±°ì˜ ì•ˆ ëŒìŒ! ğŸ˜±

ë¡œë´‡ì´ ê³„ì† í‹€ì–´ì§„ ìƒíƒœ ìœ ì§€
â†’ yaw_error: 52Â° â†’ 60Â° â†’ 70Â°
â†’ ct_error: -0.62m â†’ -0.8m â†’ -1.0m
```

### Yaw Priority ì ìš© í›„:
```
yaw_error: 52Â° â†’ ct_correction = 0 (ë¬´ì‹œ!)
omega: +0.45 rad/s  â† ì œëŒ€ë¡œ ë”! âœ…

ë¡œë´‡ì´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ íšŒì „
â†’ yaw_error: 52Â° â†’ 40Â° â†’ 30Â° â†’ 20Â°
â†’ yaw_error < 30Â° â†’ ct_correction ë‹¤ì‹œ ì¼¬
â†’ ìœ„ì¹˜ ë³´ì • ì‹œì‘
â†’ ì™„ì „ ë³µêµ¬! âœ…
```

---

## ğŸ¯ ì„ê³„ê°’ ì„ íƒ: 30ë„

### ì™œ 30ë„?

**ë„ˆë¬´ ë‚®ìœ¼ë©´ (10ë„):**
- ì •ìƒ ì£¼í–‰ ì¤‘ì—ë„ ìì£¼ êº¼ì§
- ìœ„ì¹˜ ë³´ì •ì´ ì•½í•´ì§

**ë„ˆë¬´ ë†’ìœ¼ë©´ (50ë„):**
- ì´ë¯¸ ë§ì´ í‹€ì–´ì§„ í›„
- ë³µêµ¬ê°€ ëŠë ¤ì§

**30ë„ê°€ ì ì ˆ:**
- ëª…í™•íˆ í‹€ì–´ì§„ ìƒíƒœ
- ë¹ ë¥¸ ëŒ€ì‘
- GPS ë…¸ì´ì¦ˆë³´ë‹¤ í›¨ì”¬ í¼

---

## ğŸ”„ ë‹¤ë¥¸ ì œì–´ì™€ì˜ ì¡°í™”

### 1. ì •ìƒ ì£¼í–‰ (yaw < 30Â°):
```python
omega = k_th * yaw_error + ct_correction
```
- ë°©í–¥ + ìœ„ì¹˜ ë™ì‹œ ë³´ì • âœ…

### 2. í¬ê²Œ í‹€ì–´ì§ (yaw > 30Â°):
```python
ct_correction = 0
omega = k_th * yaw_error  # ë°©í–¥ë§Œ!
```
- ë°©í–¥ ë³µêµ¬ ìš°ì„  âœ…
- ìœ„ì¹˜ëŠ” ë‚˜ì¤‘ì—

### 3. ë°©í–¥ ë³µêµ¬ í›„:
```python
yaw_error < 30Â°
â†’ ct_correction ë‹¤ì‹œ í™œì„±í™”
â†’ ìœ„ì¹˜ ë³´ì • ì‹œì‘
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ì†ë„ëŠ” ì—¬ì „íˆ ëŠë¦¼
```python
if abs(yaw_error) > 35Â°:
    v_cmd = v_min  # ê°ì†
```
- Yaw priorityì™€ ë…ë¦½ì 
- ë°©í–¥ ë³µêµ¬ ì¤‘ì—ë„ ì²œì²œíˆ ì§„í–‰

### 2. Adaptive Lookaheadì™€ ì‹œë„ˆì§€
```python
ct_error > 0.5m â†’ lookahead ê°ì†Œ
yaw_error > 30Â° â†’ ct_correction ë¬´ì‹œ
```
- ë‘ ê°€ì§€ê°€ í•¨ê»˜ ì‘ë™!

### 3. IMU ì¬ìº˜ë¦¬ë¸Œë ˆì´ì…˜
- Yaw errorê°€ IMU ë“œë¦¬í”„íŠ¸ ë•Œë¬¸ì´ë©´?
- ì¬ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì´ ë¨¼ì € ì‹¤í–‰
- Yaw priorityëŠ” ë³´ì¡° ì¥ì¹˜

---

## ğŸ“ ë²„ì „ ì •ë³´

- **ì´ì „ ë²„ì „**: v15 (ADAPTIVE LOOKAHEAD)
- **í˜„ì¬ ë²„ì „**: v16 (YAW PRIORITY)
- **ë³€ê²½ ë‚ ì§œ**: 2025-10-22
- **ë³€ê²½ ì´ìœ **: CT correctionì´ yaw correctionì„ ìƒì‡„í•˜ëŠ” ë¬¸ì œ í•´ê²°

---

## ğŸš€ í…ŒìŠ¤íŠ¸ ë°©ë²•

```bash
cd /root/nav2_v2/rtk_nav/rtk_gps_planner
python3 single_experiment.py 1
```

**í™•ì¸ í¬ì¸íŠ¸:**
1. ì»¤ë¸Œ í›„ `[YAW PRIORITY]` ë¡œê·¸ í™•ì¸
2. Yaw errorê°€ ë¹ ë¥´ê²Œ ê°ì†Œí•˜ëŠ”ì§€ í™•ì¸
3. ë°©í–¥ ë³µêµ¬ í›„ ìœ„ì¹˜ ë³´ì •ì´ ì‹œì‘ë˜ëŠ”ì§€ í™•ì¸
4. Omegaê°€ ì ì ˆí•œ ê°’ì¸ì§€ í™•ì¸ (0.3-0.5 rad/s)

---

## ğŸ’¡ ì¶”ê°€ ê°œì„  ê°€ëŠ¥ì„±

ë§Œì•½ ì´ ë³€ê²½ìœ¼ë¡œë„ ë¬¸ì œê°€ ì§€ì†ëœë‹¤ë©´:

### 1. ì„ê³„ê°’ ì¡°ì •
```python
if abs(yaw_error) > math.radians(20):  # 30 â†’ 20
    ct_correction = 0
```

### 2. ë¶€ë¶„ ë¬´ì‹œ (ì™„ì „ ë¬´ì‹œ ëŒ€ì‹ )
```python
if abs(yaw_error) > math.radians(30):
    ct_correction *= 0.3  # 70% ê°ì†Œ (ì™„ì „ ë¬´ì‹œ X)
```

### 3. Gain ì¦ê°€
```python
if abs(yaw_error) > math.radians(30):
    k_th_effective = k_th * 1.5  # Yaw gain ì¦ê°€
    ct_correction = 0
    omega = k_th_effective * yaw_error
```

